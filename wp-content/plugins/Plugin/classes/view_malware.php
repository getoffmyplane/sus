<?php
$this->admin_scripts();
$sucuri_link = 'http://anonym.to/?http://ithemes.com/sucuri';
?>
<style type="text/css">
	.inside label {
		display: block;
		vertical-align: top;
		width: 140px;
		font-weight: bold;
	}
</style>

<div class="wrap">
	<?php
	echo '<table style="width: 80%; min-width: 750px;"><tr><td>';
	$this->title( 'Malware Scan' );
	echo '</td><td align="right"><a href="' . $sucuri_link . '"><img src="' . $this->_pluginURL . '/images/sucuri/3.png" style="margin-top: 20px;" title="Malware scan powered by Sucuri" /></a></td></tr></table>';
	echo '<br />';
	
	$url = site_url();
	
	if ( $url == 'http://localhost' ) {
		echo 'ERROR: You are currently running your site locally. Your site must be internet accessible to scan.';
	} else {
	
		if ( !empty( $_GET['refresh'] ) ) {
			delete_transient( 'pb_backupbuddy_malwarescan' );
		}
		
		//echo '<br />Scanning `' . $url . '`.<br /><br />';
		
		if ( false === ( $scan = get_transient( 'pb_backupbuddy_malwarescan' ) ) ) {
			?>
			<div id="pb_backupbuddy_malwarescanloading">
			<table><tr><td><img src="<?php echo $this->_pluginURL; ?>/images/loading_large.gif" /></td><td><h1>&nbsp;Scanning for Malware... Please wait...</h1></td></tr></table>
			</div>
			<?php
			flush();
			
			$scan = wp_remote_get(
				'http://sitecheck.sucuri.net/scanner/?scan=' . urlencode( $url ) . '&serialized',
				array(
					'method' => 'GET',
					'timeout' => 45,
					'redirection' => 5,
					'httpversion' => '1.0',
					'blocking' => true,
					'headers' => array(),
					'body' => null,
					'cookies' => array()
				)
			);
			
			if ( is_wp_error( $scan ) ) {
				$this->alert( 'ERROR #24452. Unable to load Malware Scan results. Details: ' . $scan->get_error_message(), true );
				$scan = 'N;';
			} else {
				$scan = $scan['body'];
				set_transient( 'pb_backupbuddy_malwarescan', $scan, 60*60*1 ); // 1 hour cache.
			}
			?>
			<script type="text/javascript">
				jQuery(document).ready(function() {
					jQuery('#pb_backupbuddy_malwarescanloading').slideToggle();
				});
			</script>
			
			
			<?php
		}

		if ( substr( $scan, 0, 2 ) == 'N;' ) {
			echo 'An error was encountered attempting to scan this site.<br />';
			echo 'An internet connection is required and this site must be accessible on the public internet.';
			$scan = array();
		} else {
			$scan = maybe_unserialize( $scan );
			//echo '<pre>';
			//print_r( $scan );
			//echo '</pre>';
		}
		
		function lined_array( $array ) {
			if ( is_array( $array ) ) {
				foreach( $array as $array_key => $array_item ) {
					if ( is_array( $array_item ) ) {
						$array[$array_key] = lined_array( $array_item );
					}
				}
				//return implode( '<br />', $array );
				$return = '';
				foreach( $array as $array_item ) {
					$return .= $array_item . '<br />';
				}
				return $return;
			} else {
				if ( empty( $array ) ) {
					return '<i>none</i><br />';
				} else {
					return $array . '<br />';
				}
			}
		}
		
		
		if ( !empty( $scan['MALWARE'] ) ) {
			echo '<table><tr><td><img src="' . $this->_pluginURL . '/images/warning.png" style="width: 92px; height: 92px;" /></td><td><h1>Warning: Malware Detected!</h1>See details below. <a href="' . $sucuri_link . '">Sign up with Sucuri for removal assistance.</a></td></tr></table>';
		}
		?>
		
		
		<div class="postbox-container" style="width: 80%; min-width: 750px;">
				<div class="metabox-holder">
					<div class="meta-box-sortables">
						
						<div id="breadcrumbslike" class="postbox">
							<div class="handlediv" title="Click to toggle"><br /></div>
							<h3 class="hndle"><span>Malware Detected</span></h3>
							<div class="inside">
								<label>Malware</label>
								<?php
								if ( !empty( $scan['MALWARE']['WARN'] ) ) {
									echo lined_array( $scan['MALWARE']['WARN'] );
								} else {
									echo '<i>none</i><br />';
								} ?><br />
							</div>
						</div>
						
						<div id="breadcrumbslike" class="postbox">
							<div class="handlediv" title="Click to toggle"><br /></div>
							<h3 class="hndle"><span>Web server details</span></h3>
							<div class="inside">
								<label>Site</label> <?php if ( !empty( $scan['SCAN']['SITE'] ) ) { echo lined_array( $scan['SCAN']['SITE'] ); } else { echo '<i>none</i><br />'; } ?><br />
								<label>Hostname</label> <?php if ( !empty( $scan['SCAN']['DOMAIN'] ) ) { echo lined_array( $scan['SCAN']['DOMAIN'] ); } else { echo '<i>none</i><br />'; } ?><br />
								<label>IP Address</label> <?php if ( !empty( $scan['SCAN']['IP'] ) ) { echo lined_array( $scan['SCAN']['IP'] ); } else { echo '<i>none</i><br />'; } ?><br />
								<label>System details</label> <?php if ( !empty( $scan['SYSTEM']['NOTICE'] ) ) { echo lined_array( $scan['SYSTEM']['NOTICE'] ); } else { echo '<i>none</i><br />'; } ?><br />
								<label>Information</label> <?php if ( !empty( $scan['SYSTEM']['INFO'] ) ) { echo lined_array( $scan['SYSTEM']['INFO'] ); } else { echo '<i>none</i><br />'; } ?><br />
							</div>
						</div>
						
						<div id="breadcrumbslike" class="postbox">
							<div class="handlediv" title="Click to toggle"><br /></div>
							<h3 class="hndle"><span>Web application</span></h3>
							<div class="inside">
								<label>Details</label> <?php if ( !empty( $scan['WEBAPP']['INFO'] ) ) { echo lined_array( $scan['WEBAPP']['INFO'] ); } else { echo '<i>none</i><br />'; } ?><br />
								<label>Versions</label> <?php if ( !empty( $scan['WEBAPP']['VERSION'] ) ) { echo lined_array( $scan['WEBAPP']['VERSION'] ); } else { echo '<i>none</i><br />'; } ?><br />
								<label>Notices</label> <?php if ( !empty( $scan['WEBAPP']['NOTICE'] ) ) { echo lined_array( $scan['WEBAPP']['NOTICE'] ); } else { echo '<i>none</i><br />'; } ?><br />
								<label>Errors</label> <?php if ( !empty( $scan['WEBAPP']['ERROR'] ) ) { echo lined_array( $scan['WEBAPP']['ERROR'] ); } else { echo '<i>none</i><br />'; } ?><br />
								<label>Warnings</label> <?php if ( !empty( $scan['WEBAPP']['WARN'] ) ) { echo lined_array( $scan['WEBAPP']['WARN'] ); } else { echo '<i>none</i><br />'; } ?><br />
							</div>
						</div>
						
						<div id="breadcrumbslike" class="postbox">
							<div class="handlediv" title="Click to toggle"><br /></div>
							<h3 class="hndle"><span>Links</span></h3>
							<div class="inside">
								<?php if ( !empty( $scan['LINKS']['URL'] ) ) { echo lined_array( $scan['LINKS']['URL'] ); } else { echo '<i>none</i><br />'; } ?>
							</div>
						</div>
						
						<div id="breadcrumbslike" class="postbox">
							<div class="handlediv" title="Click to toggle"><br /></div>
							<h3 class="hndle"><span>Local Javascript</span></h3>
							<div class="inside">
								<?php if ( !empty( $scan['LINKS']['JSLOCAL'] ) ) { echo lined_array( $scan['LINKS']['JSLOCAL'] ); } else { echo '<i>none</i><br />'; } ?>
							</div>
						</div>
						
						<div id="breadcrumbslike" class="postbox">
							<div class="handlediv" title="Click to toggle"><br /></div>
							<h3 class="hndle"><span>External Javascript</span></h3>
							<div class="inside">
								<?php if ( !empty( $scan['LINKS']['JSEXTERNAL'] ) ) { echo lined_array( $scan['LINKS']['JSEXTERNAL'] ); } else { echo '<i>none</i><br />'; } ?>
							</div>
						</div>
						
						<div id="breadcrumbslike" class="postbox">
							<div class="handlediv" title="Click to toggle"><br /></div>
							<h3 class="hndle"><span>Iframes Included</span></h3>
							<div class="inside">
								<?php if ( !empty( $scan['LINKS']['IFRAME'] ) ) { echo lined_array( $scan['LINKS']['IFRAME'] ); } else { echo '<i>none</i><br />'; } ?>
							</div>
						</div>
						
						<div id="breadcrumbslike" class="postbox">
							<div class="handlediv" title="Click to toggle"><br /></div>
							<h3 class="hndle"><span>Blacklisting Status</span></h3>
							<div class="inside">
								<?php if ( !empty( $scan['BLACKLIST']['INFO'] ) ) { echo lined_array( $scan['BLACKLIST']['INFO'] ); } else { echo '<i>none</i><br />'; } ?>
							</div>
						</div>
						
					</div>
				</div>
			</div>
		</div>
		
		<br /><br /><br /><br />
		
		<div style="color: #AFAFAF; width: 793px;">
			Malware scan results are cached for one hour. <a href="<?php echo $this->_selfLink; ?>-malware&refresh=true" class="button-secondary">Perform New Scan Now</a>
		</div>
		
		<br /><br />
		<?php
	}
	?>
</div>